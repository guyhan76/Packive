
        <ToolButton label="Text" icon="T" onClick={addText} />
          <ToolButton label="Curved" icon="‚åí" onClick={async () => {
            const c = fcRef.current; if (!c) return;
            const text = prompt('Enter curved text:', 'CURVED TEXT') || 'CURVED TEXT';
            const radius = +(prompt('Radius (50-300):', '120') || '120');
            const { Group, FabricText } = await import('fabric');
            const chars: any[] = [];
            const totalAngle = text.length * 12;
            const startAngle = -90 - totalAngle / 2;
            for (let i = 0; i < text.length; i++) {
              const angle = startAngle + i * 12;
              const rad = (angle * Math.PI) / 180;
              const x = radius * Math.cos(rad);
              const y = radius * Math.sin(rad);
              const ch = new FabricText(text[i], {
                left: x, top: y,
                fontSize: fSize,
                fill: color,
                fontFamily: selectedFont,
                originX: 'center',
                originY: 'center',
                angle: angle + 90,
              });
              chars.push(ch);
            }
            const grp = new Group(chars, {
              left: c.width / 2,
              top: c.height / 2,
              originX: 'center',
              originY: 'center',
            });
            c.add(grp);
            c.setActiveObject(grp);
            c.renderAll();
            refreshLayers();
          }} />
          <ToolButton label="Path Text" icon="„Äú" onClick={async () => {
            const c = fcRef.current; if (!c) return;
            const text = prompt(String.fromCharCode(69,110,116,101,114) + " text for path:", "Hello Path Text") || "Hello Path Text";
            const pathType = prompt("Path type: 1=Wave 2=ArcTop 3=ArcBottom 4=S-Curve 5=Custom", "1") || "1";
            const { FabricText, Path } = await import("fabric");
            const cw = c.getWidth();
            const ch = c.getHeight();
            let pathStr = "";
            if (pathType === "1") { pathStr = "M 0 0 Q " + (cw*0.25) + " " + (-ch*0.15) + " " + (cw*0.5) + " 0 Q " + (cw*0.75) + " " + (ch*0.15) + " " + cw + " 0"; }
            else if (pathType === "2") { pathStr = "M 0 " + (ch*0.2) + " Q " + (cw*0.5) + " " + (-ch*0.2) + " " + cw + " " + (ch*0.2); }
            else if (pathType === "3") { pathStr = "M 0 0 Q " + (cw*0.5) + " " + (ch*0.4) + " " + cw + " 0"; }
            else if (pathType === "4") { pathStr = "M 0 " + (ch*0.1) + " C " + (cw*0.33) + " " + (-ch*0.15) + " " + (cw*0.66) + " " + (ch*0.35) + " " + cw + " " + (ch*0.1); }
            else if (pathType === "5") { pathStr = prompt("Enter SVG path:", "M 0 0 Q 150 -50 300 0") || "M 0 0 Q 150 -50 300 0"; }
            else { pathStr = "M 0 0 Q " + (cw*0.25) + " " + (-ch*0.15) + " " + (cw*0.5) + " 0 Q " + (cw*0.75) + " " + (ch*0.15) + " " + cw + " 0"; }
            const pathObj = new Path(pathStr, { fill: "", stroke: "", visible: false });
            const pathText = new FabricText(text, {
              left: cw / 2, top: ch / 2, fontSize: fSize, fill: color,
              fontFamily: selectedFont, originX: "center", originY: "center",
              path: pathObj,
            });
            c.add(pathText);
            c.setActiveObject(pathText);
            c.renderAll();
            refreshLayers();
          }} />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Shape</span>
            <div className="flex flex-col items-center gap-1">
            <select
              defaultValue=""
              onChange={e => {
                const v = e.target.value;
                if (!v) return;
                const actions: Record<string, () => void> = {
                  rect: addRect, roundedRect: addRoundedRect,
                  circle: addCircle, ellipse: addEllipse,
                  solidLine: addSolidLine, dashedLine: addDashedLine, dottedLine: addDottedLine,
                  verticalLine: addVerticalLine,
                  arrowRight: addArrowLineRight, arrowLeft: addArrowLineLeft, arrowBoth: addArrowLineBoth,
                  triangle: addTriangle, rightTriangle: addRightTriangle, leftTriangle: addLeftTriangle,
                  pentagon: addPentagon, hexagon: addHexagon, octagon: addOctagon,
                  diamond: addDiamond, parallelogram: addParallelogram, trapezoid: addTrapezoid,
                  star: addStar, star6: addStar6, badge: addBadge,
                  heart: addHeart, cross: addCross,
                  arrow: addArrow, chevron: addChevron, ribbon: addRibbon,
                  semiCircle: addSemiCircle, arc: addArc, wave: addWave, fan: addFan, spiral: addSpiral,
                  speechBubble: addSpeechBubble, cloud: addCloud, moon: addMoon, ring: addRing,
                  roundedSquare: addRoundedSquare, lightning: addLightning, plus: addPlus,
                };
                actions[v]?.();
                e.target.value = '';
              }}
              className="w-16 text-[9px] border rounded px-0.5 py-1 bg-white"
            >
              <option value="">Select...</option>
              <optgroup label="Basic">
                <option value="rect">‚ñ† Rectangle</option>
                <option value="roundedRect">‚ñ¢ Rounded Rect</option>
                <option value="circle">‚óè Circle</option>
                <option value="ellipse">‚¨Æ Ellipse</option>
              </optgroup>
              <optgroup label="Lines">
                <option value="solidLine">‚îÄ‚îÄ Solid Line</option>
                <option value="dashedLine">‚ïå‚ïå Dashed Line</option>
                <option value="dottedLine">¬∑¬∑¬∑ Dotted Line</option>
                <option value="verticalLine">‚îÇ Vertical Line</option>
                <option value="arrowRight">‚Üí Arrow Right</option>
                <option value="arrowLeft">‚Üê Arrow Left</option>
                <option value="arrowBoth">‚Üî Arrow Both</option>
              </optgroup>
              <optgroup label="Triangles">
                <option value="triangle">‚ñ≤ Triangle</option>
                <option value="rightTriangle">‚ó£ Right Triangle</option>
                <option value="leftTriangle">‚ó¢ Left Triangle</option>
              </optgroup>
              <optgroup label="Polygons">
                <option value="pentagon">‚¨† Pentagon</option>
                <option value="hexagon">‚¨° Hexagon</option>
                <option value="octagon">‚ØÉ Octagon</option>
                <option value="diamond">‚óÜ Diamond</option>
                <option value="parallelogram">‚ñ± Parallelogram</option>
                <option value="trapezoid">‚è¢ Trapezoid</option>
              </optgroup>
              <optgroup label="Stars & Badges">
                <option value="star">‚òÖ Star (5pt)</option>
                <option value="star6">‚ú° Star (6pt)</option>
                <option value="badge">‚ú∫ Badge</option>
              </optgroup>
              <optgroup label="Curves & Arcs">
                <option value="semiCircle">‚óó Semi Circle</option>
                <option value="arc">‚åí Arc</option>
                <option value="wave">‚àø Wave</option>
                <option value="fan">‚óî Fan</option>
                <option value="spiral">üåÄ Spiral</option>
              </optgroup>
              <optgroup label="Bubbles & Shapes">
                <option value="speechBubble">üí¨ Speech Bubble</option>
                <option value="cloud">‚òÅ Cloud</option>
                <option value="moon">‚òΩ Moon</option>
                <option value="ring">‚óé Ring</option>
                <option value="roundedSquare">‚ñ¢ Rounded Square</option>
              </optgroup>
              <optgroup label="Symbols">
                <option value="lightning">‚ö° Lightning</option>
                <option value="plus">‚ûï Plus (outline)</option>
              </optgroup>
              <optgroup label="Special">
                <option value="heart">‚ô• Heart</option>
                <option value="cross">‚úö Cross</option>
                <option value="arrow">‚û§ Arrow</option>
                <option value="chevron">‚Ä∫ Chevron</option>
                <option value="ribbon">‚öë Ribbon</option>
              </optgroup>

            </select>
          </div>
          </div>
          <ToolButton label="Image" icon="üñº" onClick={uploadImage} />

          <ToolButton label={cropMode ? "Cropping..." : "Crop"} icon="‚úÇ" onClick={() => {
            const c = fcRef.current; if (!c) return;
            if (cropMode) {
              const rect = cropRectRef.current; const target = cropTargetRef.current;
              if (rect && target && target.type === 'image') {
                const tsx=target.scaleX||1; const tsy=target.scaleY||1;
                const ox=target.originX==='center'?(target.left||0)-(target.width*tsx)/2:(target.left||0);
                const oy=target.originY==='center'?(target.top||0)-(target.height*tsy)/2:(target.top||0);
                const rsx=rect.scaleX||1; const rsy=rect.scaleY||1;
                const rw=(rect.width||0)*rsx; const rh=(rect.height||0)*rsy;
                const rx=rect.originX==='center'?(rect.left||0)-rw/2:(rect.left||0);
                const ry=rect.originY==='center'?(rect.top||0)-rh/2:(rect.top||0);
                const cropX=(rx-ox)/tsx; const cropY=(ry-oy)/tsy; const cropW=rw/tsx; const cropH=rh/tsy;
                const el=(target as any)._element||(target as any).getElement?.();
                if(el){const nW=el.naturalWidth||el.width;const nH=el.naturalHeight||el.height;
                const isx=(target.width||nW)/nW;const isy=(target.height||nH)/nH;
                const sx=Math.max(0,Math.round(cropX/isx));const sy=Math.max(0,Math.round(cropY/isy));
                const sw=Math.min(Math.round(cropW/isx),nW-sx);const sh=Math.min(Math.round(cropH/isy),nH-sy);
                const oc=document.createElement('canvas');oc.width=sw;oc.height=sh;
                const x2=oc.getContext('2d')!;x2.drawImage(el,sx,sy,sw,sh,0,0,sw,sh);
                const du=oc.toDataURL('image/png');
                import('fabric').then(F=>{F.FabricImage.fromURL(du).then((ni:any)=>{
                ni.set({left:rx,top:ry,originX:'left',originY:'top',scaleX:rw/sw,scaleY:rh/sh});
                ni.setCoords();c.remove(target);c.remove(rect);c.add(ni);c.setActiveObject(ni);c.requestRenderAll();
                if(typeof refreshLayers==='function')refreshLayers();});});}
              } else if(rect){c.remove(rect);c.requestRenderAll();}
              cropRectRef.current=null;cropTargetRef.current=null;setCropMode(false);return;
            }
            const obj=c.getActiveObject() as any;
            if(!obj||obj.type!=='image'){alert('Select an image first');return;}
            setCropMode(true);cropTargetRef.current=obj;
            const ol=obj.originX==='center'?(obj.left||0)-(obj.width*(obj.scaleX||1))/2:(obj.left||0);
            const ot=obj.originY==='center'?(obj.top||0)-(obj.height*(obj.scaleY||1))/2:(obj.top||0);
            const ow=obj.width*(obj.scaleX||1);const oh=obj.height*(obj.scaleY||1);
            import('fabric').then(F=>{const cr=new F.Rect({left:ol+ow*0.1,top:ot+oh*0.1,width:ow*0.8,height:oh*0.8,
            fill:'rgba(0,120,255,0.15)',stroke:'#0078ff',strokeWidth:2,strokeDashArray:[5,5],
            originX:'left',originY:'top',cornerColor:'#0078ff',cornerSize:8,transparentCorners:false,lockRotation:true});
            (cr as any)._isCropRect=true;c.add(cr);c.setActiveObject(cr);c.requestRenderAll();cropRectRef.current=cr;});
          }} />
          <ToolButton label="Mask" icon="üé≠" onClick={async () => {
            const c = fcRef.current; if (!c) return;
            const obj = c.getActiveObject() as any;
            if (!obj || obj.type !== 'image') { alert('Select an image first'); return; }
            const shape = prompt('Mask shape: circle, star, heart, diamond', 'circle');
            if (!shape) return;
            const { Circle, Path, Polygon } = await import('fabric');
            const w = (obj.width || 100) * (obj.scaleX || 1);
            const h = (obj.height || 100) * (obj.scaleY || 1);
            const r = Math.min(w, h) / 2;
            let clipPath: any;
            if (shape === 'circle') {
              clipPath = new Circle({ radius: r, originX: 'center', originY: 'center' });
            } else if (shape === 'star') {
              const pts: {x:number;y:number}[] = [];
              for (let si = 0; si < 10; si++) {
                const ang = (si * 36 - 90) * Math.PI / 180;
                const rad = si % 2 === 0 ? r : r * 0.4;
                pts.push({ x: rad * Math.cos(ang), y: rad * Math.sin(ang) });
              }
              clipPath = new Polygon(pts, { originX: 'center', originY: 'center' });
            } else if (shape === 'heart') {
              clipPath = new Path('M 0 -30 C -5 -50, -40 -50, -40 -20 C -40 5, -10 25, 0 40 C 10 25, 40 5, 40 -20 C 40 -50, 5 -50, 0 -30 Z',
                { originX: 'center', originY: 'center', scaleX: r/40, scaleY: r/40 });
            } else if (shape === 'diamond') {
              clipPath = new Polygon([{x:0,y:-r},{x:r*0.7,y:0},{x:0,y:r},{x:-r*0.7,y:0}], { originX: 'center', originY: 'center' });
            }
            if (clipPath) { obj.set('clipPath', clipPath); obj.dirty = true; c.requestRenderAll(); }
          }} />
          <ToolButton label="Paste" icon="üìã" onClick={async () => {
            const cv = fcRef.current; if (!cv) return;
            try {
              const items = await navigator.clipboard.read();
              for (const item of items) {
                const imageType = item.types.find((t: string) => t.startsWith('image/'));
                if (imageType) {
                  const blob = await item.getType(imageType);
                  const url = URL.createObjectURL(blob);
                  const { FabricImage } = await import('fabric');
                  const htmlImg = new Image();
                  htmlImg.src = url;
                  await new Promise<void>((res, rej) => { htmlImg.onload = () => res(); htmlImg.onerror = rej; });
                  const canvasW = cv.getWidth();
                  const canvasH = cv.getHeight();
                  const maxW = canvasW * 0.6;
                  const maxH = canvasH * 0.6;
                  const natW = htmlImg.naturalWidth || 1;
                  const natH = htmlImg.naturalHeight || 1;
                  const ratio = Math.min(maxW / natW, maxH / natH, 1);
                  const offscreen = document.createElement('canvas');
                  offscreen.width = Math.round(natW * ratio);
                  offscreen.height = Math.round(natH * ratio);
                  offscreen.getContext('2d')!.drawImage(htmlImg, 0, 0, offscreen.width, offscreen.height);
                  const dataUrl = offscreen.toDataURL('image/png');
                  const img = await FabricImage.fromURL(dataUrl);
                  img.set({ left: canvasW/2, top: canvasH/2, originX: 'center', originY: 'center' });
                  img.setCoords();
                  cv.add(img); cv.setActiveObject(img); cv.requestRenderAll();
                  refreshLayers();
                  console.log('Pasted image:', offscreen.width, 'x', offscreen.height);
                  URL.revokeObjectURL(url);
                  break;
                }
              }
            } catch (err) {
              console.error('Paste error:', err);
              alert('No image in clipboard. Copy an image first (right-click image > Copy Image, or Win+Shift+S)');
            }
          }} />
          <ToolButton label="QR Code" icon="‚óª" onClick={async () => {
            const text = prompt('Enter text or URL for QR code:');
            if (!text) return;
            const c = fcRef.current; if (!c) return;
            try {
              const QRCode = (await import('qrcode')).default;
              const dataUrl = await QRCode.toDataURL(text, { width: 200, margin: 1, color: { dark: '#000000', light: '#ffffff' } });
              const { FabricImage } = await import('fabric');
              const img = await FabricImage.fromURL(dataUrl);
              img.set({ left: c.getWidth()/2 - 100, top: c.getHeight()/2 - 100, originX: 'left', originY: 'top' });
              img.setCoords();
              c.add(img); c.setActiveObject(img); c.requestRenderAll();
              if (typeof refreshLayers === 'function') refreshLayers();
            } catch (err) { console.error('QR error:', err); alert('QR code generation failed'); }
          }} />
          <ToolButton label="Barcode" icon="|||" onClick={async () => {
            const text = prompt('Enter text for barcode:');
            if (!text) return;
            const c = fcRef.current; if (!c) return;
            try {
              const barcodeCanvas = document.createElement('canvas');
              const ctx2 = barcodeCanvas.getContext('2d')!;
              const barW = 2; const h = 80; const pad = 10;
              const totalW = text.length * barW * 11 + pad * 2;
              barcodeCanvas.width = totalW; barcodeCanvas.height = h + 20;
              ctx2.fillStyle = '#ffffff'; ctx2.fillRect(0, 0, totalW, h + 20);
              ctx2.fillStyle = '#000000';
              let x = pad;
              for (let i = 0; i < text.length; i++) {
                const bin = text.charCodeAt(i).toString(2).padStart(8, '0');
                for (let b = 0; b < bin.length; b++) { if (bin[b]==='1') ctx2.fillRect(x, 0, barW, h); x += barW; }
                x += barW * 3;
              }
              ctx2.font = '10px monospace'; ctx2.textAlign = 'center';
              ctx2.fillText(text, totalW/2, h + 14);
              const dataUrl = barcodeCanvas.toDataURL('image/png');
              const { FabricImage } = await import('fabric');
              const img = await FabricImage.fromURL(dataUrl);
              img.set({ left: c.getWidth()/2 - totalW/2, top: c.getHeight()/2 - 50, originX: 'left', originY: 'top' });
              img.setCoords();
              c.add(img); c.setActiveObject(img); c.requestRenderAll();
              if (typeof refreshLayers === 'function') refreshLayers();
            } catch (err) { console.error('Barcode error:', err); alert('Barcode generation failed'); }
          }} />
          <hr className="w-10 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Color</span>
            <div className="grid grid-cols-3 gap-[3px]">
              {colors.map(c => (
                <button key={c} onClick={() => applyColor(c)}
                  className={`w-5 h-5 rounded-sm border ${color === c ? 'ring-2 ring-blue-400' : 'border-gray-300'}`}
                  style={{ backgroundColor: c }} />
              ))}
            </div>
            <input type="color" value={color} onChange={e => applyColor(e.target.value)} className="w-10 h-5 mt-1 cursor-pointer border-0" />
            <button onClick={async () => {
              const c = fcRef.current; if (!c) return;
              if ('EyeDropper' in window) {
                try {
                  const ed = new (window as any).EyeDropper();
                  const result = await ed.open();
                  if (result?.sRGBHex) { applyColor(result.sRGBHex); setColor(result.sRGBHex); }
                } catch {}
              } else {
                c.defaultCursor = 'crosshair';
                c.selection = false;
                const handler = (opt: any) => {
                  const ctx = (c as any).getContext('2d');
                  const pointer = c.getScenePoint(opt.e);
                  const pixel = ctx.getImageData(Math.round(pointer.x), Math.round(pointer.y), 1, 1).data;
                  const hex = '#' + [pixel[0],pixel[1],pixel[2]].map((v:number) => v.toString(16).padStart(2,'0')).join('');
                  applyColor(hex); setColor(hex);
                  c.defaultCursor = 'default';
                  c.selection = true;
                  c.off('mouse:down', handler);
                };
                c.on('mouse:down', handler);
              }
            }} className="w-full py-0.5 text-[8px] bg-yellow-50 text-yellow-600 rounded hover:bg-yellow-100 mt-0.5 flex items-center justify-center gap-0.5" title="Pick Color from screen">
              ü©∏ Pick Color
            </button>
          </div>
          <hr className="w-28 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">BG Image</span>
            <button onClick={() => {
              const input = document.createElement("input");
              input.type = "file";
              input.accept = "image/*";
              input.onchange = async (ev: any) => {
                const file = ev.target.files?.[0]; if (!file) return;
                const c = fcRef.current; if (!c) return;
                const { FabricImage } = await import("fabric");
                const url = URL.createObjectURL(file);
                try {
                  // Resize image via offscreen canvas to match canvas size exactly
                  const canvasW = c.getWidth();
                  const canvasH = c.getHeight();
                  const htmlImg = new Image();
                  htmlImg.src = url;
                  await new Promise<void>((res, rej) => { htmlImg.onload = () => res(); htmlImg.onerror = rej; });
                  // Draw resized image to offscreen canvas
                  const offscreen = document.createElement('canvas');
                  offscreen.width = canvasW;
                  offscreen.height = canvasH;
                  const ctx2 = offscreen.getContext('2d')!;
                  ctx2.drawImage(htmlImg, 0, 0, canvasW, canvasH);
                  const resizedUrl = offscreen.toDataURL('image/png');
                  const img = await FabricImage.fromURL(resizedUrl);
                  img.left = 0;
                  img.top = 0;
                  img.originX = 'left';
                  img.originY = 'top';
                  img.selectable = false;
                  img.evented = false;
                  img.setCoords();
                  (img as any)._isBgImage = true;
                  const existing = c.getObjects().filter((o: any) => o._isBgImage && o !== img);
                  existing.forEach((o: any) => c.remove(o));
                  c.add(img);
                  c.sendObjectToBack(img);
                  c.requestRenderAll();
                  refreshLayers();
                  
                } catch (err) { console.error("BG image error:", err); }
                URL.revokeObjectURL(url);
              };
              input.click();
            }} className="w-[120px] py-1 text-[10px] bg-gray-100 text-gray-600 border border-gray-200 rounded hover:bg-gray-200 font-medium" title="Set background image">
              Upload BG Image
            </button>
            <button onClick={() => {
              const c = fcRef.current; if (!c) return;
              c.getObjects().forEach((o: any) => { if (o._isBgImage) c.remove(o); });
              c.renderAll();
              refreshLayers();
            }} className="w-[120px] py-1 text-[10px] bg-red-50 text-red-500 border border-red-200 rounded hover:bg-red-100 font-medium" title="Remove background image">
              Remove BG Image
            </button>
          </div>
          <hr className="w-28 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">BG Color</span>
            <div className="grid grid-cols-3 gap-[3px]">
              {['#FFFFFF','#F3F4F6','#FEE2E2','#FEF3C7','#D1FAE5','#DBEAFE','#EDE9FE','#FCE7F3','#E0E7FF','#CCFBF1','#FFF7ED','#F5F5F4'].map(c => (
                <button key={c} onClick={() => {
                  const cv = fcRef.current; if (!cv) return;
                  cv.set("backgroundColor", c); cv.renderAll();
                }}
                  className={`w-5 h-5 rounded-sm border border-gray-300`}
                  style={{ backgroundColor: c }} />
              ))}
            </div>
            <input type="color" defaultValue="#FFFFFF" onChange={e => { const cv = fcRef.current; if (cv) { cv.set("backgroundColor", e.target.value); cv.renderAll(); } }} className="w-10 h-5 mt-1 cursor-pointer border-0" />
          </div>
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">BG Gradient</span>
            <div className="flex flex-col gap-1 items-center">
              <div className="flex gap-1 items-center">
                <span className="text-[8px] text-gray-400">From</span>
                <input type="color" defaultValue="#667eea" id="gradFrom" className="w-6 h-4 cursor-pointer border-0" />
                <span className="text-[8px] text-gray-400">To</span>
                <input type="color" defaultValue="#764ba2" id="gradTo" className="w-6 h-4 cursor-pointer border-0" />
              </div>
              <select id="gradDir" defaultValue="toBottom" className="w-20 text-[8px] border rounded px-0.5 py-0.5">
                <option value="toBottom">‚Üì Top‚ÜíBottom</option>
                <option value="toRight">‚Üí Left‚ÜíRight</option>
                <option value="toDiag">‚Üò Diagonal</option>
                <option value="toRadial">‚óé Radial</option>
              </select>
              <button onClick={() => {
                const c = fcRef.current; if (!c) return;
                const from = (document.getElementById("gradFrom") as HTMLInputElement).value;
                const to = (document.getElementById("gradTo") as HTMLInputElement).value;
                const dir = (document.getElementById("gradDir") as HTMLSelectElement).value;
                let grad: any;
                import("fabric").then(({ Gradient }) => {
                  if (dir === "toRadial") {
                    grad = new Gradient({
                      type: "radial",
                      coords: { x1: c.width!/2, y1: c.height!/2, x2: c.width!/2, y2: c.height!/2, r1: 0, r2: Math.max(c.width!, c.height!)/2 },
                      colorStops: [{ offset: 0, color: from }, { offset: 1, color: to }],
                    });
                  } else {
                    const coords = dir === "toBottom" ? { x1: 0, y1: 0, x2: 0, y2: c.height! }
                      : dir === "toRight" ? { x1: 0, y1: 0, x2: c.width!, y2: 0 }
                      : { x1: 0, y1: 0, x2: c.width!, y2: c.height! };
                    grad = new Gradient({
                      type: "linear",
                      coords,
                      colorStops: [{ offset: 0, color: from }, { offset: 1, color: to }],
                    });
                  }
                  c.set("backgroundColor", grad as any);
                  c.requestRenderAll();
                });
              }} className="w-20 py-0.5 text-[9px] bg-blue-50 text-blue-600 border border-blue-200 rounded hover:bg-blue-100 font-medium">
                Apply Gradient
              </button>
            </div>
          </div>
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">BG Opacity</span>
            <input type="range" min={0} max={100} defaultValue={100}
              onChange={e => {
                const cv = fcRef.current; if (!cv) return;
                const val = +e.target.value / 100;
                const bg = String(cv.backgroundColor || "#FFFFFF");
                let r=255,g=255,b=255;
                if (bg.startsWith("#")) { r=parseInt(bg.slice(1,3),16); g=parseInt(bg.slice(3,5),16); b=parseInt(bg.slice(5,7),16); }
                else if (bg.startsWith("rgba") || bg.startsWith("rgb")) {
                  const m = bg.match(/[\d.]+/g);
                  if (m) { r=+m[0]; g=+m[1]; b=+m[2]; }
                }
                cv.set('backgroundColor', 'rgba(' + r + ',' + g + ',' + b + ',' + val + ')');
                cv.renderAll();
              }}
              className="w-[120px] h-1 accent-blue-500"
            />
          </div>
          <button onClick={() => {
              const c = fcRef.current; if (!c) return;
              const objs = c.getObjects();
              const bg = objs.find((o: any) => o.type === "rect" && o.width >= c.getWidth() * 0.9 && o.height >= c.getHeight() * 0.9 && !(o as any)._isSafeZone);
              if (bg) {
                (bg as any).set({ selectable: true, evented: true });
                c.setActiveObject(bg);
                c.renderAll();
              }
            }} className="w-[120px] py-1 text-[10px] bg-blue-50 text-blue-600 border border-blue-200 rounded hover:bg-blue-100 font-medium" title="Select template background">
              Select BG
            </button>
          <hr className="w-28 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Opacity</span>
            <input type="range" min={0} max={100} defaultValue={100}
              onChange={e => {
                const c = fcRef.current; if (!c) return;
                const obj = c.getActiveObject();
                if (obj) { (obj as any).set("opacity", +e.target.value / 100); c.requestRenderAll(); }
              }}
              className="w-[120px] h-1 accent-blue-500"
            />
          </div>
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Size</span>
            <input
  type="number"
  min={6}
  max={200}
  value={fSize}
  onChange={e => {
    const v = +e.target.value;
    if (v > 0) {
      setFSize(v);
      const c = fcRef.current; if (!c) return;
      const obj = c.getActiveObject();
      if (obj && 'fontSize' in obj) {
        (obj as any).set('fontSize', v);
        c.renderAll();
      }
    }
  }}
  className="w-14 text-xs border rounded px-1 py-0.5"
/>

          </div>    
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Line Height</span>
            <input
              type="range"
              min={80}
              max={300}
              defaultValue={120}
              onChange={e => {
                const v = +e.target.value / 100;
                const c = fcRef.current; if (!c) return;
                const obj = c.getActiveObject() as any;
                if (obj) {
                  obj.lineHeight = v;
                  obj.dirty = true;
                  if (obj.initDimensions) obj.initDimensions();
                  if (obj.setCoords) obj.setCoords();
                  c.requestRenderAll();
                }
              }}
              className="w-[100px] h-1 accent-blue-500"
            />
            <span className="text-[8px] text-gray-300">0.8 ‚Äî 3.0</span>
          </div>
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Letter Spacing</span>
            <input
              type="range"
              min={-200}
              max={1000}
              defaultValue={0}
              onChange={e => {
                const v = +e.target.value;
                const c = fcRef.current; if (!c) return;
                const obj = c.getActiveObject() as any;
                if (obj && ("charSpacing" in obj || obj.type === "i-text" || obj.type === "textbox")) {
                  obj.set("charSpacing", v);
                  obj.dirty = true;
                  if (obj.initDimensions) obj.initDimensions();
                  if (obj.setCoords) obj.setCoords();
                  c.requestRenderAll();
                }
              }}
              className="w-[100px] h-1 accent-blue-500"
            />
            <span className="text-[8px] text-gray-300">-200 ‚Äî 1000</span>
          </div>
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Stroke Color</span>
            <input type="color" defaultValue="#000000"
              onChange={e => {
                const c = fcRef.current; if (!c) return;
                const obj = c.getActiveObject() as any;
                if (obj) { obj.set("stroke", e.target.value); obj.dirty = true; c.requestRenderAll(); }
              }}
              className="w-8 h-5 cursor-pointer border-0"
            />
          </div>
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Stroke Width</span>
            <input type="range" min={0} max={10} defaultValue={0} step={0.5}
              onChange={e => {
                const v = +e.target.value;
                const c = fcRef.current; if (!c) return;
                const obj = c.getActiveObject() as any;
                if (obj) {
                  obj.set("strokeWidth", v);
                  obj.set("paintFirst", "stroke");
                  obj.dirty = true;
                  if (obj.setCoords) obj.setCoords();
                  c.requestRenderAll();
                }
              }}
              className="w-[100px] h-1 accent-blue-500"
            />
            <span className="text-[8px] text-gray-300">0 ‚Äî 10</span>
          </div>
          <hr className="w-10 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Image Filters</span>
            <div className="flex flex-col gap-1 w-[120px]">
              <div className="flex items-center gap-1">
                <span className="text-[8px] text-gray-400 w-[42px]">Bright</span>
                <input type="range" min={-100} max={100} defaultValue={0} onChange={async e => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (!obj || obj.type !== 'image') return;
                  const F = await import('fabric');
                  const filters = obj.filters || [];
                  const idx = filters.findIndex((f:any) => f instanceof F.filters.Brightness);
                  if (idx >= 0) filters.splice(idx, 1);
                  filters.push(new F.filters.Brightness({ brightness: +e.target.value / 100 }));
                  obj.filters = filters;
                  obj.applyFilters();
                  c.requestRenderAll();
                }} className="flex-1 h-1 accent-blue-500" />
              </div>
              <div className="flex items-center gap-1">
                <span className="text-[8px] text-gray-400 w-[42px]">Contrast</span>
                <input type="range" min={-100} max={100} defaultValue={0} onChange={async e => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (!obj || obj.type !== 'image') return;
                  const F = await import('fabric');
                  const filters = obj.filters || [];
                  const idx = filters.findIndex((f:any) => f instanceof F.filters.Contrast);
                  if (idx >= 0) filters.splice(idx, 1);
                  filters.push(new F.filters.Contrast({ contrast: +e.target.value / 100 }));
                  obj.filters = filters;
                  obj.applyFilters();
                  c.requestRenderAll();
                }} className="flex-1 h-1 accent-blue-500" />
              </div>
              <div className="flex items-center gap-1">
                <span className="text-[8px] text-gray-400 w-[42px]">Saturate</span>
                <input type="range" min={-100} max={100} defaultValue={0} onChange={async e => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (!obj || obj.type !== 'image') return;
                  const F = await import('fabric');
                  const filters = obj.filters || [];
                  const idx = filters.findIndex((f:any) => f instanceof F.filters.Saturation);
                  if (idx >= 0) filters.splice(idx, 1);
                  filters.push(new F.filters.Saturation({ saturation: +e.target.value / 100 }));
                  obj.filters = filters;
                  obj.applyFilters();
                  c.requestRenderAll();
                }} className="flex-1 h-1 accent-blue-500" />
              </div>
              <div className="flex items-center gap-1">
                <span className="text-[8px] text-gray-400 w-[42px]">Blur</span>
                <input type="range" min={0} max={100} defaultValue={0} onChange={async e => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (!obj || obj.type !== 'image') return;
                  const F = await import('fabric');
                  const filters = obj.filters || [];
                  const idx = filters.findIndex((f:any) => f instanceof F.filters.Blur);
                  if (idx >= 0) filters.splice(idx, 1);
                  filters.push(new F.filters.Blur({ blur: +e.target.value / 100 }));
                  obj.filters = filters;
                  obj.applyFilters();
                  c.requestRenderAll();
                }} className="flex-1 h-1 accent-blue-500" />
              </div>
              <div className="flex gap-1 mt-1">
                <button onClick={async () => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (!obj || obj.type !== 'image') return;
                  const F = await import('fabric');
                  const filters = obj.filters || [];
                  const idx = filters.findIndex((f:any) => f instanceof F.filters.Grayscale);
                  if (idx >= 0) { filters.splice(idx, 1); } else { filters.push(new F.filters.Grayscale()); }
                  obj.filters = filters;
                  obj.applyFilters();
                  c.requestRenderAll();
                }} className="flex-1 py-0.5 text-[8px] bg-gray-100 rounded hover:bg-gray-200">B&W</button>
                <button onClick={async () => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (!obj || obj.type !== 'image') return;
                  const F = await import('fabric');
                  const filters = obj.filters || [];
                  const idx = filters.findIndex((f:any) => f instanceof F.filters.Sepia);
                  if (idx >= 0) { filters.splice(idx, 1); } else { filters.push(new F.filters.Sepia()); }
                  obj.filters = filters;
                  obj.applyFilters();
                  c.requestRenderAll();
                }} className="flex-1 py-0.5 text-[8px] bg-gray-100 rounded hover:bg-gray-200">Sepia</button>
                <button onClick={async () => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (!obj || obj.type !== 'image') return;
                  obj.filters = [];
                  obj.applyFilters();
                  c.requestRenderAll();
                }} className="flex-1 py-0.5 text-[8px] bg-red-50 text-red-500 rounded hover:bg-red-100">Reset</button>
              </div>
            </div>
          </div>
          <hr className="w-10 border-gray-200" />
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Rotation</span>
            <div className="flex items-center gap-1">
              <input
                type="number"
                min={-360}
                max={360}
                defaultValue={0}
                onChange={e => {
                  const v = +e.target.value;
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject();
                  if (obj) {
                    obj.set("angle", v);
                    obj.setCoords();
                    c.requestRenderAll();
                  }
                }}
                className="w-12 text-xs border rounded px-1 py-0.5 text-center"
              />
              <span className="text-[8px] text-gray-300">¬∞</span>
            </div>
          </div>
          <hr className="w-10 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Shadow</span>
            <button onClick={() => {
              const c = fcRef.current; if (!c) return;
              const obj = c.getActiveObject() as any;
              if (!obj) return;
              const newOn = !textShadowOn;
              setTextShadowOn(newOn);
              if (newOn) {
                import('fabric').then(F => {
                  obj.set('shadow', new F.Shadow({ color: shadowColor, blur: shadowBlur, offsetX: shadowOffX, offsetY: shadowOffY }));
                  c.renderAll();
                });
              } else {
                obj.set('shadow', null);
                c.renderAll();
              }
            }} className={`w-full px-2 py-0.5 text-[8px] rounded ${textShadowOn ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
              {textShadowOn ? 'Shadow ON' : 'Shadow OFF'}
            </button>
            {textShadowOn && (
              <div className="flex flex-col items-center gap-0.5 bg-blue-50 p-1 rounded w-full">
                <div className="flex items-center gap-1">
                  <span className="text-[7px] text-gray-400">Color</span>
                  <input type="color" value={shadowColor} onChange={e => {
                    const v = e.target.value; setShadowColor(v);
                    const c = fcRef.current; if (!c) return;
                    const obj = c.getActiveObject() as any;
                    if (obj?.shadow) { obj.shadow.color = v; c.renderAll(); }
                  }} className="w-5 h-3 cursor-pointer border-0" />
                </div>
                <div className="flex items-center gap-1">
                  <span className="text-[7px] text-gray-400">Blur</span>
                  <input type="range" min={0} max={30} value={shadowBlur} onChange={e => {
                    const v = +e.target.value; setShadowBlur(v);
                    const c = fcRef.current; if (!c) return;
                    const obj = c.getActiveObject() as any;
                    if (obj?.shadow) { obj.shadow.blur = v; c.renderAll(); }
                  }} className="w-[50px] h-1 accent-blue-400" />
                  <span className="text-[7px] text-gray-300">{shadowBlur}</span>
                </div>
                <div className="flex items-center gap-1">
                  <span className="text-[7px] text-gray-400">X</span>
                  <input type="range" min={-20} max={20} value={shadowOffX} onChange={e => {
                    const v = +e.target.value; setShadowOffX(v);
                    const c = fcRef.current; if (!c) return;
                    const obj = c.getActiveObject() as any;
                    if (obj?.shadow) { obj.shadow.offsetX = v; c.renderAll(); }
                  }} className="w-[40px] h-1 accent-blue-400" />
                  <span className="text-[7px] text-gray-400">Y</span>
                  <input type="range" min={-20} max={20} value={shadowOffY} onChange={e => {
                    const v = +e.target.value; setShadowOffY(v);
                    const c = fcRef.current; if (!c) return;
                    const obj = c.getActiveObject() as any;
                    if (obj?.shadow) { obj.shadow.offsetY = v; c.renderAll(); }
                  }} className="w-[40px] h-1 accent-blue-400" />
                </div>
              </div>
            )}
          </div>
          <hr className="w-10 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Font</span>
            <select
              value={selectedFont}
              onChange={e => {
                const ff = e.target.value;
                setSelectedFont(ff);
                const c = fcRef.current; if (!c) return;
                const obj = c.getActiveObject();
                if (obj && 'fontFamily' in obj) {
                  (obj as any).set('fontFamily', ff);
                  c.renderAll();
                }
              }}
              className="w-16 text-[9px] border rounded px-0.5 py-0.5"
            >
              {FONT_LIST.map(f => (
                <option key={f.name} value={f.family} style={{ fontFamily: f.family }}>
                  {f.name}
                </option>
              ))}
              {customFonts.map(f => (
                <option key={'custom_'+f.name} value={f.family} style={{ fontFamily: f.family }}>
                  ‚òÖ {f.name}
                </option>
              ))}
            </select>
          <input ref={fontUploadRef} type="file" accept=".ttf,.otf,.woff,.woff2" className="hidden" onChange={async e => {
            const file = e.target.files?.[0];
            if (!file) return;
            const name = file.name.replace(/\.(ttf|otf|woff2?)/i, '');
            const family = 'custom_' + name.replace(/[^a-zA-Z0-9]/g, '_');
            try {
              const ab = await file.arrayBuffer();
              const font = new FontFace(family, ab);
              await font.load();
              (document as any).fonts.add(font);
              setCustomFonts(prev => [...prev, { name, family }]);
              setSelectedFont(family);
              const c = fcRef.current;
              if (c) { const obj = c.getActiveObject(); if (obj && 'fontFamily' in obj) { (obj as any).set('fontFamily', family); c.renderAll(); } }
            } catch (err) { console.error('Font load error:', err); alert('Failed to load font'); }
            e.target.value = '';
          }} />
          <button onClick={() => fontUploadRef.current?.click()} className="w-full py-0.5 text-[8px] bg-purple-50 text-purple-600 rounded hover:bg-purple-100 mt-0.5" title="Upload .ttf/.otf/.woff font">
            üìÅ Upload Font
          </button>
          </div>
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Align</span>
            <select
              className="w-14 text-[10px] border border-gray-200 rounded px-0.5 py-0.5 bg-white"
              onChange={async e => {
                const align = e.target.value;
                const c = fcRef.current; if (!c) return;
                const obj = c.getActiveObject() as any;
                if (!obj || !('text' in obj)) return;
                if (obj.type === 'i-text') {
                  const fabric = await import('fabric');
                  const cw = c.getWidth();
                  const tb = new fabric.Textbox(obj.text, {
                    left: 10,
                    top: obj.top,
                    originX: 'left',
                    originY: obj.originY,
                    width: cw - 20,
                    fontSize: obj.fontSize,
                    fontFamily: obj.fontFamily,
                    fontWeight: obj.fontWeight,
                    fontStyle: obj.fontStyle,
                    fill: obj.fill,
                    textAlign: align as 'left' | 'center' | 'right',
                    editable: true,
                    lineHeight: obj.lineHeight || 1.16,
                  });
                  c.remove(obj);
                  c.add(tb);
                  c.setActiveObject(tb);
                } else {
                  obj.set('textAlign', align);
                  if (obj.width < c.getWidth() * 0.5) {
                    obj.set('width', c.getWidth() - 20);
                    obj.set('left', 10);
                    obj.set('originX', 'left');
                  }
                }
                c.renderAll();
              }}

              defaultValue="center"
            >

              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
          </div>
          <div className="flex flex-col items-center gap-0.5">
            <span className="text-[9px] text-gray-400">Style</span>
            <div className="flex gap-0.5">
              <button
                className="w-6 h-6 text-[11px] font-bold border border-gray-200 rounded hover:bg-gray-100"
                title="Bold"
                onClick={() => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (obj && 'fontWeight' in obj) {
                    obj.set('fontWeight', obj.fontWeight === 'bold' ? 'normal' : 'bold');
                    c.renderAll();
                  }
                }}
              >B</button>
              <button
                className="w-6 h-6 text-[11px] italic border border-gray-200 rounded hover:bg-gray-100"
                title="Italic"
                onClick={() => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (obj && 'fontStyle' in obj) {
                    obj.set('fontStyle', obj.fontStyle === 'italic' ? 'normal' : 'italic');
                    c.renderAll();
                  }
                }}
              >I</button>
              <button
                className="w-6 h-6 text-[11px] underline border border-gray-200 rounded hover:bg-gray-100"
                title="Underline"
                onClick={() => {
                  const c = fcRef.current; if (!c) return;
                  const obj = c.getActiveObject() as any;
                  if (obj && 'underline' in obj) {
                    obj.set('underline', !obj.underline);
                    c.renderAll();
                  }
                }}
              >U</button>
            </div>
          </div>
          <hr className="w-28 border-gray-200" />
          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Position</span>
            <div className="grid grid-cols-3 gap-0.5">
              <button onClick={() => { const c = fcRef.current; if (!c) return; const o = c.getActiveObject(); if (o) { o.set("left", 0); o.set("originX", "left"); c.renderAll(); } }} title="Align Left" className="w-6 h-6 text-[9px] border border-gray-200 rounded hover:bg-gray-100">‚á§</button>
              <button onClick={() => { const c = fcRef.current; if (!c) return; const o = c.getActiveObject(); if (o) { o.set("left", c.getWidth() / 2); o.set("originX", "center"); c.renderAll(); } }} title="Center H" className="w-6 h-6 text-[9px] border border-gray-200 rounded hover:bg-gray-100">‚áî</button>
              <button onClick={() => { const c = fcRef.current; if (!c) return; const o = c.getActiveObject(); if (o) { o.set("left", c.getWidth()); o.set("originX", "right"); c.renderAll(); } }} title="Align Right" className="w-6 h-6 text-[9px] border border-gray-200 rounded hover:bg-gray-100">‚á•</button>
              <button onClick={() => { const c = fcRef.current; if (!c) return; const o = c.getActiveObject(); if (o) { o.set("top", 0); o.set("originY", "top"); c.renderAll(); } }} title="Align Top" className="w-6 h-6 text-[9px] border border-gray-200 rounded hover:bg-gray-100">‚§í</button>
              <button onClick={() => { const c = fcRef.current; if (!c) return; const o = c.getActiveObject(); if (o) { o.set("top", c.getHeight() / 2); o.set("originY", "center"); c.renderAll(); } }} title="Center V" className="w-6 h-6 text-[9px] border border-gray-200 rounded hover:bg-gray-100">‚áï</button>
              <button onClick={() => { const c = fcRef.current; if (!c) return; const o = c.getActiveObject(); if (o) { o.set("top", c.getHeight()); o.set("originY", "bottom"); c.renderAll(); } }} title="Align Bottom" className="w-6 h-6 text-[9px] border border-gray-200 rounded hover:bg-gray-100">‚§ì</button>
            </div>
          </div>

          <hr className="w-10 border-gray-200" />

          <div className="flex flex-col items-center gap-1">
            <span className="text-[9px] text-gray-400">Group</span>
            <div className="flex gap-0.5">
            <button onClick={async () => {
              const c = fcRef.current; if (!c) return;
              const sel = c.getActiveObject();
              if (sel && sel.type === 'activeselection') {
                const { Group } = await import("fabric");
                const objects = [...(sel as any)._objects];
                c.discardActiveObject();
                objects.forEach((o:any) => c.remove(o));
                const group = new Group(objects, { selectable: true });
                c.add(group);
                c.setActiveObject(group);
                c.renderAll();
                refreshLayers();
              }
            }} title="Group" className="w-8 h-8 flex items-center justify-center text-[10px] border border-gray-200 rounded hover:bg-gray-100 font-bold">G</button>
            <button onClick={() => {
              const c = fcRef.current; if (!c) return;
              const sel = c.getActiveObject();
              if (sel && sel.type === 'group') {
                const objects = [...(sel as any)._objects];
                c.remove(sel);
                objects.forEach((o:any) => c.add(o));
                c.renderAll();
                refreshLayers();
              }
            }} title="Ungroup" className="w-8 h-8 flex items-center justify-center text-[10px] border border-gray-200 rounded hover:bg-gray-100 font-bold">UG</button>
            </div>
          </div>
          <hr className="w-28 border-gray-200" />
          <ToolButton label="Clone" icon="üìã" onClick={async () => {
            const c = fcRef.current; if (!c) return;
            const obj = c.getActiveObject();
            if (!obj) return;
            if (obj.type === "image") {
              const { FabricImage } = await import("fabric");
              const tmpCanvas = document.createElement("canvas");
              const o = obj as any;
              tmpCanvas.width = o.getScaledWidth();
              tmpCanvas.height = o.getScaledHeight();
              const tmpCtx = tmpCanvas.getContext("2d");
              if (tmpCtx && o._element) {
                tmpCtx.drawImage(o._element, 0, 0, tmpCanvas.width, tmpCanvas.height);
                const dataUrl = tmpCanvas.toDataURL("image/png");
                const img = await FabricImage.fromURL(dataUrl);
                img.set({ left: (obj.left||0)+20, top: (obj.top||0)+20, scaleX: 1, scaleY: 1, angle: obj.angle });
                c.add(img); c.setActiveObject(img); c.renderAll(); refreshLayers();
              }
            } else {
              const cloned = await obj.clone();
              cloned.set({ left: (obj.left||0)+20, top: (obj.top||0)+20 });
              c.add(cloned); c.setActiveObject(cloned); c.renderAll(); refreshLayers();
            }
          }} />
          <ToolButton label="Delete" icon="üóë" onClick={del} />
          
          <ToolButton label={drawMode ? "Drawing" : "Draw"} icon="‚úè" onClick={() => {
            const c = fcRef.current; if (!c) return;
            if (drawMode) {
              c.isDrawingMode = false;
              setDrawMode(false);
            } else {
              c.isDrawingMode = true;
              import('fabric').then(F => {
                const brush = new F.PencilBrush(c);
                brush.color = color;
                brush.width = brushSize;
                c.freeDrawingBrush = brush;
              });
              setDrawMode(true);
            }
          }} />
          {drawMode && (
            <div className="flex flex-col items-center gap-1 bg-yellow-50 p-1 rounded">
              <span className="text-[8px] text-gray-400">Pen Size</span>
              <input type="range" min={1} max={20} value={brushSize} onChange={e => {
                const s = +e.target.value;
                setBrushSize(s);
                const c = fcRef.current;
                if (c && c.freeDrawingBrush) { c.freeDrawingBrush.width = s; c.freeDrawingBrush.color = color; }
              }} className="w-[80px] h-1 accent-blue-500" />
              <span className="text-[8px] text-gray-300">{brushSize}px</span>
              <span className="text-[8px] text-gray-400">Pen Color</span>
              <input type="color" value={color} onChange={e => {
                const newColor = e.target.value;
                setColor(newColor);
                const c = fcRef.current;
                if (c && c.freeDrawingBrush) c.freeDrawingBrush.color = newColor;
              }} className="w-8 h-4 cursor-pointer border-0" />
              <div className="flex gap-1 mt-1">
                <button onClick={() => {
                  const c = fcRef.current; if (!c) return;
                  setEraserMode(false);
                  c.isDrawingMode = true;
                  import('fabric').then(F => {
                    const brush = new F.PencilBrush(c);
                    brush.color = color;
                    brush.width = brushSize;
                    c.freeDrawingBrush = brush;
                  });
                }} className={`flex-1 py-0.5 text-[8px] rounded ${!eraserMode ? 'bg-blue-200 text-blue-700 ring-1 ring-blue-400' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>‚úè Pen</button>
                <button onClick={() => {
                  const c = fcRef.current; if (!c) return;
                  const newEM = !eraserMode;
                  setEraserMode(newEM);
                  if (newEM) {
                    c.isDrawingMode = true;
                    import('fabric').then(F => {
                      const brush = new F.PencilBrush(c);
                      brush.color = '#FFFFFF';
                      brush.width = eraserSize;
                      (brush as any)._isEraser = true;
                      c.freeDrawingBrush = brush;
                    });
                  } else {
                    c.isDrawingMode = true;
                    import('fabric').then(F => {
                      const brush = new F.PencilBrush(c);
                      brush.color = color;
                      brush.width = brushSize;
                      c.freeDrawingBrush = brush;
                    });
                  }
                }} className={`flex-1 py-0.5 text-[8px] rounded ${eraserMode ? 'bg-red-200 text-red-700 ring-1 ring-red-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>üßπ Eraser</button>
              </div>
              <button onClick={() => {
                const c = fcRef.current; if (!c) return;
                const objs = c.getObjects().filter((o: any) => o.type === 'path' && !o._isBgImage && !o._isSafeZone && !o._isGuideLine && !o._isCropRect);
                if (objs.length > 0) {
                  c.remove(objs[objs.length - 1]);
                  c.requestRenderAll();
                  refreshLayers();
                }
              }} className="w-full py-0.5 text-[8px] bg-red-50 text-red-500 rounded hover:bg-red-100 mt-1">Undo Last Stroke</button>
              {eraserMode && (
                <div className="flex flex-col items-center gap-0.5 mt-1 bg-red-50 p-1 rounded">
                  <span className="text-[8px] text-red-400">Eraser Size</span>
                  <input type="range" min={5} max={60} value={eraserSize} onChange={e => {
                    const s = +e.target.value;
                    setEraserSize(s);
                    const c = fcRef.current;
                    if (c && c.freeDrawingBrush && eraserMode) c.freeDrawingBrush.width = s;
                  }} className="w-[80px] h-1 accent-red-400" />
                  <span className="text-[8px] text-red-300">{eraserSize}px</span>
                </div>
              )}
            </div>
          )}
<ToolButton label={measureMode ? "ON" : "Measure"} icon="üìè" onClick={() => {
            setMeasureMode(m => {
              const next = !m;
              const c = fcRef.current; if (!c) return next;
              if (!next) {
                // Clean up measure objects
                if (measureLineRef.current) { try { c.remove(measureLineRef.current); } catch {} measureLineRef.current = null; }
                if (measureTextRef.current) { try { c.remove(measureTextRef.current); } catch {} measureTextRef.current = null; }
                measureStartRef.current = null;
                c.selection = true;
                c.forEachObject((o: any) => { if (!o._isSafeZone && !o._isGuideLine && !o._isBgImage) { o.selectable = true; o.evented = true; } });
                c.defaultCursor = "default";
                c.requestRenderAll();
              } else {
                c.discardActiveObject();
                c.selection = false;
                c.forEachObject((o: any) => { o.selectable = false; o.evented = false; });
                c.defaultCursor = "crosshair";
                c.requestRenderAll();
              }
              return next;
            });
          }} />
          <button onClick={async () => {
            const c = fcRef.current; if (!c) return;
            if (!confirm("Clear canvas? This cannot be undone.")) return;
            const all = c.getObjects().slice();
            all.forEach((o:any) => c.remove(o));
            c.set('backgroundColor', '#FFFFFF');
            // Re-add safe zone and guide text
            const { Rect, FabricText } = await import('fabric');
            const cw = c.getWidth(); const ch = c.getHeight();
            const sc = scaleRef.current; const mg = Math.round(5 * sc);
            const sz = new Rect({ left: mg, top: mg, originX: 'left', originY: 'top', width: cw - mg*2, height: ch - mg*2, fill: 'transparent', stroke: '#93B5F7', strokeWidth: 1.5, strokeDashArray: [8,5], selectable: false, evented: false });
            (sz as any)._isSafeZone = true;
            c.add(sz);
            const gt = new FabricText(guideText, { left: cw/2, top: ch/2 - 10, originX: 'center', originY: 'center', fontSize: 13, fill: '#C0C0C0', fontFamily: 'Arial, sans-serif', selectable: false, evented: false });
            c.add(gt);
            c.renderAll();
            refreshLayers();
          }} className="w-[120px] py-1 text-[10px] bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100 font-medium" title="Clear Canvas">
            Clear Canvas
          </button>
          <div className="flex gap-0.5">
            <button onClick={undo} title="Undo" className="w-8 h-8 flex items-center justify-center text-sm border border-gray-200 rounded hover:bg-gray-100">‚Ü©</button>
            <button onClick={redo} title="Redo" className="w-8 h-8 flex items-center justify-center text-sm border border-gray-200 rounded hover:bg-gray-100">‚Ü™</button>
          </div>
        